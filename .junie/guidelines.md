Project guidelines for advanced contributors

Scope and intent
- This document captures project-specific knowledge for dndstoryteller to speed up development, testing, and debugging. It focuses on concrete steps for this repository’s NestJS backend and Vite/React frontend.

Overview
- Monorepo root: /home/phoenix/projects/dndstoryteller
  - backend: NestJS 11, TypeORM 0.3, Postgres, Jest.
  - frontend: Vite + React 18, Tailwind v4, MobX, PrimeReact.
  - OpenAPI schema is generated by the backend and used to generate a typed API client in frontend/generated.

Backend (NestJS)
1) Install and build
- Node >= 20 is recommended. From repo root:
  - cd backend
  - npm ci
  - npm run build

2) Execution variants
- Dev server with live reload: npm run start:dev
- Prod build run: npm run start:prod (requires dist/, created via npm run build)

3) Environment configuration
- Config relies on process.env; see src/utils/getEnvVariable.ts and files importing it.
- Required for TypeORM (src/config/typeorm.ts):
  - POSTGRES_HOST
  - POSTGRES_PORT (default 5432 if unset)
  - POSTGRES_USER
  - POSTGRES_PASSWORD
  - POSTGRES_DATABASE
  - Notes: synchronize is false; use migrations.
- JWT / Auth (src/modules/auth/*):
  - JWT_SECRET (defaults to "your-secret-key" if unset; set a strong key)
  - JWT_EXPIRES_IN (defaults to "1d")
  - AUTH_GOOGLE_CLIENT_ID (required for Google token validation)
- App behavior (src/main.ts):
  - APP_ENV=dev enables OpenAPI generation at startup and writes openapi-schema.json to backend root.
  - CORS origin is currently hardcoded to http://localhost:5173; adjust for non-local dev.

4) Database and migrations
- Migrations are compiled to dist/migrations with entities in dist/**/*.entity.js.
- Commands (see package.json):
  - npm run migration:generate — generates a migration after building; data source configured at src/config/typeorm.ts.
  - npm run migration:run — applies pending migrations.
  - npm run migration:revert — reverts last migration.
- Ensure env vars for DB connection are set before running these commands.

5) OpenAPI schema and frontend client generation
- At backend startup with APP_ENV=dev, swagger document is written to backend/openapi-schema.json.
- To generate a TypeScript API client for frontend:
  - cd backend
  - npm run generate:api-client
  - Output goes to ../frontend/generated/api.ts using swagger-typescript-api with axios adapter and module name index set to 1.

6) Testing (backend)
- Unit tests: Jest is configured in backend/package.json (rootDir src, testRegex .*\.spec\.ts$).
- E2E tests: backend/test/jest-e2e.json defines .e2e-spec.ts pattern.
- Commands:
  - npm test — run unit tests
  - npm run test:watch — watch mode
  - npm run test:cov — coverage
  - npm run test:e2e — e2e tests

Notes on adding/modifying tests
- Many services depend on repositories or other providers. Provide these via TestingModule providers or import the owning module.
- Example (mocking a repository dependency):
  - If UsersService depends on a UserRepository token, in the spec:
    - const mockRepo = { findOne: jest.fn(), save: jest.fn() };
    - Test.createTestingModule({ providers: [ UsersService, { provide: 'UserRepository', useValue: mockRepo } ] })
  - Alternatively import UsersModule if it exports all required providers.
- Avoid hitting a real DB in unit tests; mock repository methods instead.

Selective test execution
- Run a single spec: npm test -- src/app.controller.spec.ts
- Run by name pattern: npm test -- -t "should be defined"

Verified simple test example (for demonstration)
- A minimal self-test can be executed with Node without relying on Nest context. This is useful to validate CI plumbing or demonstrate the test process independently of Nest providers.
- Example commands executed successfully in this repo (from backend directory):
  - node -e "import('node:assert/strict').then(a=>{a.equal(2+3,5);console.log('ok')})"
- For Jest-based examples, ensure all required providers are mocked; otherwise, Nest DI will throw resolution errors, as seen when running users.service.spec.ts without a mocked repository.

Frontend (Vite/React)
1) Install and run
- From repo root:
  - cd frontend
  - npm ci
  - npm run dev — starts Vite on http://localhost:5173
  - npm run build — production build
  - npm run preview — preview built assets

2) Environment variables
- Vite requires env vars prefixed with VITE_. Utilized keys:
  - VITE_API_URL — base URL for axios client (src/utils/apiClient.ts). Example: http://localhost:3000/api
  - VITE_AUTH_GOOGLE_CLIENT_ID — used by GoogleOAuthProvider on login page.

3) API client
- Frontend imports Api from frontend/generated/api (generated by backend task). Re-generate after backend schema changes.

4) Linting and formatting
- Frontend: eslint (eslint, eslint-plugin-react, eslint-plugin-prettier) and prettier. Scripts:
  - npm run lint — fail on warnings; checks src with js,jsx,ts,tsx
  - npm run lintfix — autofix
- Backend: eslint + prettier. Script:
  - npm run lint — applies eslint with --fix over {src,apps,libs,test}/**/*.ts
- Adopt existing .eslintrc.js in backend; be aware of TypeScript explicit return type rules turned off.

5) Debugging tips
- Backend
  - Use npm run start:debug or attach a debugger to Node with --inspect if needed (see package.json test:debug too).
  - To troubleshoot env values, log ConfigService.get(...) early in module setup or enable APP_ENV=dev to emit OpenAPI schema.
  - If Jest DI errors occur, check providers/imports in Test.createTestingModule and mock data sources/repositories.
- Frontend
  - Verify VITE_API_URL and CORS: backend enables CORS for http://localhost:5173 by default (src/main.ts). Adjust origin for different hosts/ports.
  - 401 handling: src/utils/apiClient.ts clears token and redirects to /auth/login via react-router redirect().

End-to-end local run (happy path)
1) Start Postgres locally with a database matching env vars, or point the app to an existing instance via POSTGRES_*.
2) Backend
  - Export env vars (POSTGRES_*, JWT_SECRET, AUTH_GOOGLE_CLIENT_ID, optionally APP_ENV=dev).
  - npm ci && npm run migration:run && npm run start:dev
3) Frontend
  - Export VITE_API_URL=http://localhost:3000/api and VITE_AUTH_GOOGLE_CLIENT_ID=... (Google OAuth Client ID)
  - npm ci && npm run dev

Testing guidance summary
- Prefer unit tests with mocked repositories/providers.
- Use e2e only when you need to exercise HTTP endpoints; consider spinning up a test database or using an in-memory strategy if acceptable.
- Keep openapi-schema.json in sync (APP_ENV=dev) and re-generate clients to avoid type drift between layers.
